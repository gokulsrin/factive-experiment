<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Factive Experiment</title>
        <script src="./jspsych/jspsych.js"></script>
        <script src="./jspsych/plugin-html-keyboard-response.js"></script>
        <script src="./jspsych/plugin-video-keyboard-response.js"></script>
        <script src="./jspsych/plugin-video-button-response.js"></script>
        <script src="./jspsych/plugin-image-button-response.js"></script>
        <script src="./jspsych/plugin-survey-html-form.js"></script>
        <script src="./jspsych/plugin-html-button-response.js"></script>
        <script src="./jspsych/plugin-html-keyboard-response.js"></script>
        <script src="./jspsych/plugin-survey-multi-choice.js"></script>
        <script src="./jspsych/plugin-survey-multi-select.js"></script>
        <script src="./jspsych/plugin-preload.js"></script>
        <script src="./jspsych/plugin-survey-text.js"></script>
        <script src="./filler.js"></script>
        <script src="./instruction/instruction.js"></script>
        <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css"/>
    </head>
    <body>
    <script>
        /* This function here will allow us to send the data from the completed survey to the server */
        function save_data(data) {
            url = location + "data"
            var xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                data
            }));
        }
        /* This will allow us to use jspsych moving forward, and it also configures certain display settings, 
        as well as what will happen when the survey is completed...
        */
        var responses = {}
        const jsPsych = initJsPsych({
            show_progress_bar: true,
            // override_safe_mode:true, 
            on_finish: function(){
                //display survery data 
                console.log(db);
                //send both the responses and the data
                save_data([responses, db]);
                document.write('<p style="text-align:center"> You have completed the survey. Thank you for your cooperation. Your survey code is: "6B6B20F9".</p>');
            }
        }); 

        var timeline = [];
         /* Opening instructions */

        /* Consent form for the study*/
        var consent = {
            type: jsPsychHtmlButtonResponse,
            stimulus: "<DIV align='left'><div>&nbsp;</div><div>Please consider this information carefully before deciding whether to participate in this research.</div><div>&nbsp;\<div>The purpose of this research is to examine which factors influence social judgment and decision-</div><div>making.You will be asked to make judgements about individuals and actions in social scenarios.</div><div>We are simply interested in your judgement. The study will take less than 1 hour to complete,</div><div>and you will receive less than $20 on Prolific. Your compensation and time</div><div>commitment are specified in the study description. There are no anticipated risks associated with</div><div>participating in this study. The effects of participating should be comparable to those you would</div><div>ordinarily experience from viewing a computer monitor and using a mouse or keyboard for a</div><div>similar amount of time. At the end of the study, we will provide an explanation of the questions</div><div>that motivate this line of research and will describe the potential implications.</div><div>&nbsp;</div><div>Your participation in this study is completely voluntary and you may refuse to participate or you</div><div>may choose to withdraw at any time without penalty or loss of benefits to you which are</div><div>otherwise entitled. Your participation in this study will remain confidential. No personally</div><div>identifiable information will be associated with your data. Also, all analyses of the data will be</div><div>averaged across all the participants, so your individual responses will never be specifically</div><div>analyzed.</div><div>&nbsp;</div><div>If you have questions or concerns about your participation or payment, or want to request a</div><div>summary of research findings, please contact Dr. Jonathan Phillips at</div><div><a href=mailto:Jonathan.S.Phillips@dartmouth.edu>Jonathan.S.Phillips@dartmouth.edu</a>.</div><div>&nbsp;</div><div>Please save a copy of this form for your records.</div><div>&nbsp;</div></DIV><div>Agreement:</div><DIV align='left'><div>The nature and purpose of this research have been sufficiently explained and I agree to</div><div>participate in this study. I understand that I am free to withdraw at any time without incurring</div><div>any penalty. Please consent by clicking the button below to continue. Otherwise, please exit the</div><div>study at any time.</div><div>&nbsp;</div></DIV>",
            choices: ['Submit'],
            //this specifies the way in which the data will be configured inside jspsych data variable...
            data:{
                internal_type: "consent"
            },
        };
        timeline.push(consent);
        /* alternate drop down participant info 
        - one of the problems here is that this form does not force participants to respond. 
        */
        var feedback_demographics = {
            type: jsPsychSurveyHtmlForm,
            html: '<div style="max-width:700px; text-align:center;"> <p>' +
                'What factors influenced how you decided to respond? Do you' +
                ' have any questions or comments regarding the experiment?' +
                '</p> <textarea name="feedback" cols="40" rows="6"' +
                ' "autofocus"></textarea> <p> Please provide the following' +
                ' information to complete the study. </p> <div style="text-' +
                'align:center;"> <div style="text-align:left; display:' +
                'inline-block; margin-right:20px; line-height:1.8em;"> <ol>' +
                    '<li>Age:</li> <br><br>' +
                    '<li>Gender:</li> <br><br>' +
                    '<li>Race:</li> <br><br><br><br><br><br>' +
                    '<li>Ethnicity:</li>' +
                '</ol> </div>' +
                '<div style="text-align:left; display: inline-block;' +
                ' line-height:1.8em;">' +
                    // age text box
                    '<input name="age" type="number"  min="18" max="100" /> <br> <br>' +
                    // gender options
                    '<input name="gender" type="radio" id="female" value=' +
                        '"Female" /> <label for="female"> Female </label>' +
                    '<input name="gender" type="radio" id="male" value=' +
                        '"Male" /> <label for="male"> Male </label>' +
                    '<input name="gender" type="radio" id="nonbinary" value=' +
                        '"Non-binary" /> <label for="nonbinary"> Non-binary </label> <br>' +
                    '<input name="gender" type="radio" id="other_gender" value=' +
                        '"other_gender" /> <label for="other_gender"> Other: <input' +
                        ' type="text" name="other_gender" /> </label> <br><br>' +
                    // race options
                    '<input name="race" type="radio" id="white" value=' +
                        '"White" /> <label for="white"> White </label> <br>' +
                    '<input name="race" type="radio" id="black" value=' +
                        '"Black/African American" /> <label for="black">' +
                        ' Black/African American </label> <br>' +
                    '<input name="race" type="radio" id="am_ind" value=' +
                        '"American Indian/Alaska Native" /> <label for="am_ind">' +
                        ' American Indian/Alaska Native </label> <br>' +
                    '<input name="race" type="radio" id="asian" value=' +
                        '"Asian" /> <label for="asian"> Asian </label> <br>' +
                    '<input name="race" type="radio" id="pac_isl" value=' +
                        '"Native Hawaiian/Pacific Islander" /> <label for="pac_isl">' +
                        ' Native Hawaiian/Pacific Islander </label> <br>' +
                    '<input name="race" type="radio" id="multi" value=' +
                        '"Multiracial" /> <label for="multi"> Multiracial/Mixed </label> <br>' +
                    '<input name="race" type="radio" id="other_race" value="other_race" />' +
                        '<label for="other_race"> Other: <input type="text"' +
                        'name="other_race" /> </label> <br><br>' +
                    // ethnicity options
                    '<input name="ethnicity" type="radio" id="hisp" value=' +
                        '"Hispanic" /> <label for="hisp"> Hispanic </label>' +
                    '<input name="ethnicity" type="radio" id="nonhisp" value=' +
                        '"Non-Hispanic" /> <label for="nonhisp"> Non-Hispanic' +
                        ' </label>' +
                '</div> </div>', 
                on_finish: function(data){
                    console.log(data);
                },
        }
        timeline.push(feedback_demographics);

        /* Collection of participant info*/
        var participant_info = {
            type: jsPsychSurveyText,
            preamble: 'Please provide us with some demographic information.',
            questions: [
                {prompt: "How old are you?", placeholder: 'ex: 34',required: true}, 
                {prompt: "Which is your dominant hand (e.g.,Right, Left, Ambidextrous)?", required:true}, 
                {prompt: "What is your native language?", required: true}, 
                {prompt: "What is your nationality?", required: true}, 
                {prompt: "In which country do you live?", required: true},
                {prompt: "What is your gender (e.g., Male, Female, Other)?", required:true}, 
                {prompt: '<p style="width:500px;">What is your education level (e.g., Grade/elementary school, High school, Some college or university, College or university degree, Graduate degree, Masters, PhD)<p>?', required: true},
                {prompt: "Prolific Worker ID", required: true}
            ],
            data:{
                internal_type: "participant_info"
            },
            on_finish: function(data){
                responses["age"] = data.response['Q0'];
                responses["handedness"] = data.response["Q1"];
                responses["language"] = data.response["Q2"];
                responses["nationality"] = data.response["Q3"];
                responses["residence"] = data.response["Q4"];
                responses["gender"] = data.response["Q5"];
                responses["education"] = data.response["Q6"];
                responses["id"] = data.response["Q7"];
            },
        };
        // timeline.push(participant_info);
        var filler_questions = {"pirate":pirate_filler, "school":school_filler, "spy":spy_filler};
        console.log(filler_questions);

        /* pushing the study description and the practice trial instructions */
        // var study_description = {
        //     type: jsPsychHtmlButtonResponse,
        //     stimulus: study_description, 
        //     choices: ['Submit'],
        //     data:{
        //         internal_type: "study description"
        //     },
        // }
        // timeline.push(study_description);
         // preload the instructional video and other videos - this seems to work fine but may need to be changed... 
         var preload = {
            type: jsPsychPreload,
            auto_preload: true, 
        }
        // practice trial instructions
        var practice_trial_instructions = {
            type: jsPsychHtmlButtonResponse,
            stimulus: practice_trial_instructions, 
            choices: ['Continue'],
            data:{
                internal_type: "practice trial instructions"
            },
        }
        timeline.push(practice_trial_instructions);

        var practice_trial_image = {
            type: jsPsychImageButtonResponse,
            stimulus: 'instruction/handposition.png',
            stimulus_height: 500, 
            maintain_aspect_ratio: true, 
            // prompt: "Please click continue.",
            // stimulus: practice_trial_instructions, 
            choices: ['Continue'],
            data:{
                internal_type: "practice trial image"
            },
        }
        timeline.push(practice_trial_image);

        /* Instruction trial 
            - This will work by providing them some test video video 
            - asking them to answer the questions correctly, and repeating the questions until they answer correctly 
        */
       

        function create_instruction_trial(timeline){
            // this will be the internal timeline that we use to create this 
            var timeline2 = [];
            //add video here 
            var video = {
                    type: jsPsychVideoKeyboardResponse, 
                    controls: true, 
                    autoplay: false, 
                    stimulus: ['instruction/trial.mp4'],
                    prompt: '<h5> Press play when you are ready and watch each video once. Press the spacebar to continue.</h5>',
                    choices: [" "],
                    on_finish: function(data){
                    //    console.log("")
                    }
            }
            timeline2.push(video);
            //post video instructions 
            var p_video_instructions = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: post_video_instructions,
                choices: [' '],
                    on_finish: function(data){
                    //    console.log("")
                },
            }
            timeline2.push(p_video_instructions);
            for (var key in instruction_trial){
                console.log(key);
                var trial = {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: key,
                    //15 seconds 
                    trial_duration: 15000, 
                }
                var loop_node = {
                    timeline: [trial],
                    // this repeats the question if they are wrong
                    loop_function: function(data){
                        if(jsPsych.pluginAPI.compareKeys(data.values()[0].response, instruction_trial[key])){
                            return true;
                        } else {
                            return false;
                        }
                    }
                }
                timeline2.push(loop_node);
                var fixation = {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: '<div style="font-size:60px;">+</div>',
                    choices: "NO_KEYS",
                    trial_duration: 3000,
                };
                timeline2.push(fixation);
            }
            const it = {
                timeline:timeline2,
            }
            timeline.push(it);
        }
        create_instruction_trial(timeline);
        /* push post instruction trial script */
        var pits = {
            type: jsPsychHtmlButtonResponse, 
            stimulus: post_instruction_script, 
            choices: ["Continue"],
        }
        timeline.push(pits);
        /* Doing the prep work for the relevent target question manipulation we will do later */
        var context = ["spy", "pirate", "school"];
        var conditions = ["EI", "FB", "G", "NI", "SI", "TB"];
        var condition_qs = {
            "school":{
                "FB": {"Does Dr. C know where Billy is?":"N", "Does Jane know where Billy is?":"N"}, 
                "SI":{"Does Dr. C know where Billy is?":"N", "Does Jane know where Billy is?":"N"}, 
                "EI":{"Does Dr. C know where Billy is?":"Y", "Does Jane know where Billy is?":"N"}, 
                "NI":{"Does Dr. C know where Billy is?":"N", "Does Jane know where Billy is?":"N"}, 
                "TB":{"Does Dr. C know where Billy is?":"Y", "Does Jane know where Billy is?":"N"}, 
                "G":{"Does Dr. C know where Billy is?":"Y", "Does Jane know where Billy is?":"Y"}, 
            }, 
            "spy":{
                "FB": {"Does Captain know where Maria is?":"N", "Does Harry know where Maria is?":"N"}, 
                "SI":{"Does Captain know where Maria is?":"N", "Does Harry know where Maria is?":"N"},
                "EI":{"Does Captain know where Maria is?":"Y", "Does Harry know where Maria is?":"N"},
                "NI":{"Does Captain know where Maria is?":"N", "Does Harry know where Maria is?":"N"},
                "TB":{"Does Captain know where Maria is?":"Y", "Does Harry know where Maria is?":"N"},
                "G":{"Does Captain know where Maria is?":"Y", "Does Harry know where Maria is?":"Y"},
            }, 
            "pirate":{
                "FB":{"Does Lieutenant Jack know where Commander Greenville is?":"N", "Does Major Bryant know where Commander Greenville is?":"N"}, 
                "SI":{"Does Lieutenant Jack know where Commander Greenville is?":"N", "Does Major Bryant know where Commander Greenville is?":"N"}, 
                "EI":{"Does Lieutenant Jack know where Commander Greenville is?":"N", "Does Major Bryant know where Commander Greenville is?":"Y"}, 
                "NI":{"Does Lieutenant Jack know where Commander Greenville is?":"N", "Does Major Bryant know where Commander Greenville is?":"N"}, 
                "TB":{"Does Lieutenant Jack know where Commander Greenville is?":"Y", "Does Major Bryant know where Commander Greenville is?":"Y"}, 
                "G":{"Does Lieutenant Jack know where Commander Greenville is?":"Y", "Does Major Bryant know where Commander Greenville is?":"Y"}, 
            }

        }   
        /* Prep work for pushing the 3 distinct scenarios with 6 different conditions 
        - so, I have to establish a mapping
        - create a shuffle algorithm 
        - and do some other stuff
         */
        var video_names = []
        for (c of context){
            for (cond of conditions){
                video_names.push(`./videos/${c}/${cond}.mp4`);
            }
        }
        //quick context mapping
        cmap = {};
        for (c of context){
            for (cond of conditions){
                cmap[`./videos/${c}/${cond}.mp4`] = [c, cond];
            }
        }
         /* credit to https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array*/
         function shuffle(array) {
            let currentIndex = array.length,  randomIndex;
            // While there remain elements to shuffle...
            while (currentIndex != 0) {
                // Pick a remaining element...
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                // And swap it with the current element.
                [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        //shuffle order videos is displayed
        video_names = shuffle(video_names);
        console.log(video_names);
       
        video_names = [video_names[0]];
        
        // this will store the most recent video_name
        var most_recent = ["shshs"];

        // db[i] = [context, condition, question, response, correct_response, rt]  
        var db = [];
        /* q = yes, p = no */
        function create_video_trials(video_names, timeline){
            for (title of video_names){
                //this will be the timeline that will contain the video-question sequence
                timeline2 = [];
                //prevideo instructions 
                var vinstruct = {
                    type: jsPsychHtmlButtonResponse,
                    stimulus: video_instructions,
                    choices: ['Continue'],
                    // prompt: "<p>What color is the ink?</p>",
                }
                timeline2.push(vinstruct);
                var video = {
                    type: jsPsychVideoKeyboardResponse, 
                    autoplay: false, 
                    controls: true, 
                    stimulus: [title],
                    prompt: '<h5> Please watch the video carefully and press the spacebar to continue. </h5>',
                    choices: [" "],
                    on_finish: function(data){
                        console.log(data);
                        console.log(db);
                        console.log(cmap[data.stimulus[0]]);
                        most_recent = cmap[data.stimulus[0]]; //most recent allows me to format the sql row such that I know the context and condition of every entry
                    }
                }
                timeline2.push(video);
                //instructions for post video questions
                var p_video_instructions = {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: post_video_instructions,
                    choices: [' '],
                        on_finish: function(data){
                        //    console.log("")
                    },
                }
                timeline2.push(p_video_instructions);
                /* pushing the non-filler, target questions here into the array that will later be shuffled */
                t = []; //array that will contain all the target + context specific filler questions
                for (var text in condition_qs[cmap[title][0]][cmap[title][1]]) {
                    console.log(text);
                    var correct_ans = condition_qs[cmap[title][0]][cmap[title][1]][text];
                    console.log(correct_ans);
                    var target = {
                        type: jsPsychHtmlKeyboardResponse, 
                        stimulus: text,
                        choices: ["q", "p"], 
                        trial_duration: 15000, 
                        on_finish: function(data){
                            // 0 == yes, 1 == no
                            db.push([responses["id"], most_recent[0], most_recent[1], data.stimulus, data.response, correct_ans, data.rt]);
                        }
                    }
                    t.push(target);
                }
               
                /* depending on the condition, we will ask different filler. plus, these question need to be in random order */
                /* Apparently we've decided to just add 1 filler - so the point here is to randomly insert 1 filler question */
                var c = cmap[title][0];
                if(c == "pirate"){
                    var questions = [];
                    //previous version
                    for (key in pirate_filler){
                        questions.push(key);
                        // var question = {
                        //     type: jsPsychHtmlKeyboardResponse, 
                        //     choices: ["q", "p"],
                        //     stimulus: key,
                        //     on_finish: function(data){
                        //         db.push([responses["id"], most_recent[0], most_recent[1], data.stimulus, data.response, pirate_filler[data.stimulus], data.rt]);
                        //     }
                        // }
                        // t.push(question);
                    }
                    // new 
                    var question = {
                        type: jsPsychHtmlKeyboardResponse, 
                        choices: ["p", "q"], 
                        trial_duration: 15000, 
                        stimulus: questions[Math.floor(Math.random()*questions.length)],
                        on_finish: function(data){
                            db.push([responses["id"], most_recent[0], most_recent[1], data.stimulus, data.response, pirate_filler[data.stimulus], data.rt]);
                        }
                    }
                    t.push(question);
                    //randomize order
                    t = shuffle(t);
                    //push all of these to the real timeline
                    for(question of t){
                        timeline2.push(question);
                        var fixation = {
                            type: jsPsychHtmlKeyboardResponse,
                            stimulus: '<div style="font-size:60px;">+</div>',
                            choices: "NO_KEYS",
                            trial_duration: 3000,
                        };
                        timeline2.push(fixation);
                    }
                }
                else if(c == "spy"){
                    var questions = []
                    for (key in spy_filler){
                        questions.push(key);
                        // var question = {
                        //     type: jsPsychHtmlKeyboardResponse, 
                        //     choices: ["q", "p"],
                        //     stimulus: key,
                        //     on_finish: function(data){
                        //         db.push([responses["id"], most_recent[0], most_recent[1], data.stimulus, data.response, spy_filler[data.stimulus], data.rt]);
                        //     }
                        // }
                        // t.push(question);
                    }
                    var question = {
                        type: jsPsychHtmlKeyboardResponse, 
                        choices: ["p", "q"], 
                        trial_duration: 15000,
                        stimulus: questions[Math.floor(Math.random()*questions.length)],
                        on_finish: function(data){
                            db.push([responses["id"], most_recent[0], most_recent[1], data.stimulus, data.response, spy_filler[data.stimulus], data.rt]);
                        }
                    }
                    t.push(question);
                    //randomize order
                    t = shuffle(t);
                    //push all of these to the real timeline
                    for(question of t){
                        timeline2.push(question);
                        var fixation = {
                            type: jsPsychHtmlKeyboardResponse,
                            stimulus: '<div style="font-size:60px;">+</div>',
                            choices: "NO_KEYS",
                            trial_duration: 3000,
                        };
                        timeline2.push(fixation);
                    }
                }
                else if(c == "school"){
                    var questions = []
                    for (key in school_filler){
                        questions.push(key);
                        // var question = {
                        //     type: jsPsychHtmlKeyboardResponse, 
                        //     choices: ["q", "p"],
                        //     stimulus: key,
                        //     on_finish: function(data){
                        //         db.push([responses["id"], most_recent[0], most_recent[1], data.stimulus, data.response, school_filler[data.stimulus], data.rt]);
                        //     }
                        // }
                        // t.push(question);
                    }
                    var question = {
                        type: jsPsychHtmlKeyboardResponse, 
                        choices: ["p", "q"], 
                        trial_duration: 15000,
                        stimulus: questions[Math.floor(Math.random()*questions.length)],
                        on_finish: function(data){
                            db.push([responses["id"], most_recent[0], most_recent[1], data.stimulus, data.response, school_filler[data.stimulus], data.rt]);
                        }
                    }
                    t.push(question);
                    //randomize order
                    t = shuffle(t);
                
                    //push all of these to the real timeline
                    for(question of t){
                        timeline2.push(question);
                        var fixation = {
                            type: jsPsychHtmlKeyboardResponse,
                            stimulus: '<div style="font-size:60px;">+</div>',
                            choices: "NO_KEYS",
                            trial_duration: 3000,
                        };
                        timeline2.push(fixation);
                    }
                }
                //now we create new combined variable with the combined timeline
                const video_question = {
                    timeline:timeline2,
                    on_finish:function(data){
                        // console.log(data);
                    }
                }
                //push this to main timeline
                timeline.push(video_question);
            }
        }
        create_video_trials(video_names, timeline);
          
        jsPsych.run(timeline);

    </script>
    </body>
</html>